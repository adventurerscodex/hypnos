<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/response.js | hypnos</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="An API client and ORM for CoreAPI powered REST APIs."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="hypnos"><meta property="twitter:description" content="An API client and ORM for CoreAPI powered REST APIs."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/adventurerscodex/hypnos"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hypnos.js~Hypnos.html">Hypnos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/response.js~APIResponse.html">APIResponse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tokens.js~InstanceToken.html">InstanceToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tokens.js~ModelToken.html">ModelToken</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models">models</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/base.js~BaseModel.html">BaseModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/ko.js~KOModel.html">KOModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/model.js~Model.html">Model</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/response.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import uuid from &apos;uuid&apos;;


/**
 * An APIResponse is a convenience wrapper around the data received when doing
 * a mapped query to the API.
 *
 * If a model instance is provided, the APIResponse will map the response data
 * to the model (see Model Serialization for more information). The APIResponse
 * also remembers the original response data for reference.
 *
 * Accessing the Response Objects
 * ------------------------------
 * Depending on the type of query, responses are mapped to either the `object`
 * or `objects` (note the plural) property on the APIResponse. In the case of
 * a query that will return multiple objects (i.e. when the `many` flag is set)
 * the resulting objects will be mapped and set to the `objects` property.
 * Otherwise single objects are always mapped to the `object` property.
 *
 * Navigating Paginated Responses
 * ------------------------------
 * A APIResponse provides an easy way to navigate through paginated results.
 * When retrieving a result set that is paginated (i.e. with
 * `Persistence.service.list()`), APIResponse provides two convenience methods:
 *
 * - getNextPage: Will fetch the next page in a result set if there is one.
 * - getPreviousPage: Will fetch the previous page in a result set if there is one.
 *
 * Using these two methods you can navigate the results of the query you made
 * originally. Note that you cannot change the parameters or modify the state
 * of the query once it is made. To sort and filter based on different critera,
 * you&apos;ll need to make a new query from the Persistence.service.
 *
 */
class APIResponse {

    constructor(data, keys, params, requestId, model=null, many=false) {
        this.id = uuid.v4().toString();
        this.fetchParams = params;
        this.fetchKeys = keys;
        this.data = data;
        this.requestId = requestId;
        this.many = many;
        this.model = model;

        // Map response to model object(s).
        if (model &amp;&amp; data) {
            if (many &amp;&amp; data.results) {
                this.objects = data.results.map(result =&gt; {
                    const instance = new model();
                    instance.importValues(result);
                    return instance;
                });
            } else {
                const instance = new model();
                instance.importValues(data);
                this.object = instance;
            }
        }
    }

    /**
     * Returns whether or not the given fetch response has a next page.
     */
    hasNextPage = () =&gt; (
        this.many &amp;&amp; this.data.next
    );

    /**
     * Returns whether or not the given fetch response has a previous page.
     */
    hasPreviousPage = () =&gt; (
        this.many &amp;&amp; this.data.previous
    );

    /**
     * Fetch the next page of results in a paginated result set.
     *
     * This method returns a promise to the APIResponse of the next page.
     *
     * WARNING: This method will throw an error when attempting to fetch a next
     * page for a single object result set or if there is no next page.
     * To avoid this, check if the APIResponse `hasNextPage` before calling.
     */
    getNextPage = () =&gt; (new Promise((resolve) =&gt; {
        if (!this.many || !this.hasNextPage()) {
            throw new Error(`Given APIResponse: ${this.id} does not have a next value.`);
        }

        const nextPageFetchParams = { ...this.fetchParams, page: this._getNextPageNumber() };
        return Persistence.service.action(
            this.fetchKeys,
            nextPageFetchParams,
            false,
            this.model,
            this.many
        ).then(resolve);
    }));

    /**
     * Fetch the previous page of results in a paginated result set.
     *
     * This method returns a promise to the APIResponse of the previous page.
     *
     * WARNING: This method will throw an error when attempting to fetch a previous
     * page for a single object result set or if there is no previous page.
     * To avoid this, check if the APIResponse `hasPreviousPage` before calling.
     */
    getPreviousPage = () =&gt; (new Promise((resolve) =&gt; {
        if (!this.many || !this.hasPreviousPage()) {
            throw new Error(`Given APIResponse: ${this.id} does not have a previous value.`);
        }
        const previousPageFetchParams = { ...this.fetchParams, page: this._getPreviousPageNumber() };
        return Persistence.service.action(
            this.fetchKeys,
            previousPageFetchParams,
            false,
            this.model,
            this.many
        ).then(resolve);
    }));

    /* Private Methods */

    _getCurrentPage = () =&gt; (
        this.fetchParams.page ? this.fetchParams.page : 1
    );

    _getNextPageNumber = () =&gt; (
        this._getCurrentPage() + 1
    );

    _getPreviousPageNumber = () =&gt; (
        this._getCurrentPage() - 1
    );
}


export default APIResponse;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
